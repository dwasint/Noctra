name: Sync from Vanderlin
on:
  schedule:
    - cron: "0 3 * * *"   # runs daily at 3am UTC
  workflow_dispatch:       # allow manual trigger
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Noctra repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Add Vanderlin remote and fetch
        run: |
          git remote add vanderlin https://github.com/Monkestation/Vanderlin.git
          git fetch vanderlin
          git fetch origin
          
      - name: Debug - Check current state
        run: |
          echo "=== Current branch and remotes ==="
          git branch -a
          git remote -v
          echo "=== Latest commit in origin/main ==="
          git log -1 --oneline origin/main
          echo "=== Latest commit in vanderlin/main ==="
          git log -1 --oneline vanderlin/main
          echo "=== Checking for differences ==="
          git diff --stat origin/main vanderlin/main || echo "Diff command failed"
          
      - name: Create and switch to sync branch
        run: |
          # Delete existing sync branch if it exists
          git branch -D sync-from-vander 2>/dev/null || true
          git push origin --delete sync-from-vander 2>/dev/null || true
          
          # Create fresh sync branch from current main
          git checkout -b sync-from-vander origin/main
          
      - name: Merge Vanderlin changes
        id: merge_step
        run: |
          # Attempt to merge Vanderlin's main branch
          if git merge vanderlin/main --no-ff --allow-unrelated-histories -m "Sync from Vanderlin: $(date)"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "Merge completed successfully"
          else
            echo "merge_status=conflicts" >> $GITHUB_OUTPUT
            echo "Merge conflicts detected - will create PR for manual resolution"
            
            # List conflicted files and save to output
            echo "=== CONFLICTED FILES ==="
            conflicted_files=$(git diff --name-only --diff-filter=U)
            echo "$conflicted_files"
            echo "conflicted_files<<EOF" >> $GITHUB_OUTPUT
            echo "$conflicted_files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Show conflict summary
            echo "=== CONFLICT SUMMARY ==="
            git status --porcelain | grep "^UU\|^AA\|^DD" || echo "No standard conflict markers found"
            
            # Add all files (including conflicted ones) to staging
            git add -A
            
            # Create a commit with the conflicts
            git commit -m "WIP: Sync from Vanderlin with conflicts - needs manual resolution"
          fi
          
      - name: Push sync branch
        run: |
          git push origin sync-from-vander --force
          
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare PR body based on merge status
          if [ "${{ steps.merge_step.outputs.merge_status }}" = "conflicts" ]; then
            pr_body="This PR merges the latest changes from Vanderlin into Noctra.

           **MERGE CONFLICTS DETECTED** - Manual resolution required.

          ## Conflicted Files:
          \`\`\`
          ${{ steps.merge_step.outputs.conflicted_files }}
          \`\`\`

          Please review and resolve the conflicts in the files listed above.

          Auto-generated sync from GitHub Actions run #${{ github.run_number }}
          Triggered at: $(date)"
            pr_title="MERGE CONFLICTS: Sync updates from Vanderlin - ${{ github.run_id }}"
          else
            pr_body="This PR merges the latest changes from Vanderlin into Noctra.

           **Merge completed successfully** - Ready to review and merge.

          Auto-generated sync from GitHub Actions run #${{ github.run_number }}
          Triggered at: $(date)"
            pr_title="Sync updates from Vanderlin - ${{ github.run_id }}"
          fi

          # Create PR using GitHub CLI
          gh pr create \
            --base main \
            --head sync-from-vander \
            --title "$pr_title" \
            --body "$pr_body" \
            || echo "PR may already exist"
